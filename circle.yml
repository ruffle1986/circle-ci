machine:
  node:
    version: 4.2.1

deployment:
  tagging:
    branch: master
    commands:
      - >
        if [ -n $RELEASE_TYPE ]; then
          git config --global user.email "ftamas.mail@gmail.com"
          git config --global user.name "ruffle1986"
          npm version $RELEASE_TYPE;
          repo=https://$GITHUB_ACCESS_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME.git;
          git push $repo master &> /dev/null;
          git push --tags $repo &> /dev/null;
        fi
  release:
    branch: master
    tag: /v.*/
    commands:
      - npm prune --production
      - npm dedupe
      # gh-release parses this folder by default
      - mkdir -p release
      # archive the app (excluding git folder and using the package version)
      - tar cvzp --exclude '.git' --exclude 'release'  -f "release/circleci-$(npv).tgz" .
      # to get the version of the package
      - npm i -g npv
      # install gh-release package to upload the release to github
      - curl -L -o gh-release_2.2.0_linux_x86_64.tgz https://github.com/progrium/gh-release/releases/download/v2.2.0/gh-release_2.2.0_linux_x86_64.tgz
      - tar zxf gh-release_2.2.0_linux_x86_64.tgz
      # launch the release
      - ./gh-release create ruffle1986/circle-ci $(npv)
